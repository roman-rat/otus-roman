### Шаги настройки автоматического запуска скрипта:

1. **Установили Nginx и почтовый клиент s-nail:**
   - Установили Nginx для работы веб-сервера.
   - Установили почтовую утилиту `s-nail` для отправки писем через скрипт.

2. **Создали Bash-скрипт для анализа логов:**
   - Написали скрипт `test.sh`, который анализирует логи Nginx и отправляет отчёт по электронной почте.
   - Установили права на выполнение скрипта с помощью команды `chmod +x`.

3. **Настроили конфиг почтовой утилиты:**

   ![конфиг почтовой утилиты](screens/0.png)

   _конфиг почтовой утилиты_

4. **Настроили CRON для автоматического запуска:**
   - Добавили задачу в `crontab`, чтобы скрипт запускался автоматически каждый час (исключительно ради теста, чтобы не терять время на проверку, уменьшали время до раз в 10 минут.)

   ```bash
   sudo crontab -e
   0 * * * * /home/vagrant/test.sh
   ```

5. **Проверили работу скрипта:**
   - Убедились, что скрипт запускается по расписанию и отправляет отчеты по электронной почте. У нас они попали в спам, так что лучше перепроверять данную папку.

   ![Проверка отправки отчета](screens/1.png)

   _Проверка отправки отчета_

---

### Описание скрипта для анализа логов Nginx

#### Основные компоненты скрипта

1. **Настройки:**
   - Указываем папку с логами Nginx, адрес для отправки отчета, временные файлы для хранения данных и файл блокировки, чтобы не запускать скрипт дважды одновременно.

2. **Ловушка (`trap`) для очистки:**
   - Настраиваем команду, которая всегда срабатывает при завершении работы скрипта или возникновении ошибки, чтобы удалить временные файлы и снять блокировку.

#### Скрипт разбит на функции, каждая из которых отвечает за свою задачу:

- **`cleanup_and_exit`** — Удаляет временные файлы и файл блокировки, если скрипт завершился или прервался.

- **`check_lock`** — Проверяет, работает ли уже скрипт. Если да, то завершает работу текущего запуска; если нет, создает файл блокировки, чтобы другие копии не запускались одновременно.

- **`determine_time_range`** — Определяет, какой период времени нужно анализировать. Если скрипт запускался ранее, берет время последнего запуска. Если нет — берет последний час.

- **`load_logs`** — Находит и собирает все логи Nginx, измененные после последнего запуска, во временный файл и очищает их от ненужных символов.

- **`analyze_logs`** — Извлекает нужную информацию из логов: наиболее активные IP-адреса, популярные URL, ошибки и коды HTTP-ответов.

- **`create_report`** — Создает текстовый отчет с собранными данными, включая информацию об IP-адресах, URL, ошибках и кодах ответов.

- **`send_report`** — Отправляет созданный отчет на указанный адрес электронной почты.

- **`main`** — Главная функция, которая последовательно запускает все остальные функции.

Теперь сервер автоматически анализирует логи Nginx и отправляет отчеты по почте каждый час, помогая следить за возможными проблемами.
